<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Parceria - WLs Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .back-btn {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: linear-gradient(135deg, #2c3e50, #1a252f);
            transform: translateY(-2px);
        }

        .partnership-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .partnership-title {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .partnership-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            color: #7f8c8d;
            font-size: 14px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .network-badge {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            outline: none;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group input:disabled,
        .form-group textarea:disabled {
            background: #f5f6fa;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #1f618d);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .wallets-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
            z-index: 1000;
            max-width: 350px;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success { border-left-color: #27ae60; }
        .notification.error { border-left-color: #e74c3c; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .content-grid { grid-template-columns: 1fr; }
            .partnership-title { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <a href="/dashboard" class="back-btn">
                ‚Üê Voltar ao Dashboard
            </a>
            <div id="userInfo" style="color: #2c3e50; font-weight: 600;"></div>
        </div>

        <div class="partnership-header">
            <h1 class="partnership-title" id="partnershipTitle">Carregando...</h1>
            <div class="partnership-meta">
                <div class="meta-item">
                    <span class="network-badge" id="networkBadge">-</span>
                </div>
                <div class="meta-item">
                    üë§ <span id="createdBy">-</span>
                </div>
                <div class="meta-item">
                    üìÖ <span id="createdDate">-</span>
                </div>
                <div class="meta-item">
                    ‚úèÔ∏è <span id="lastModified">-</span>
                </div>
            </div>
        </div>

        <div class="content-grid">
            <div class="info-card">
                <h3 class="card-title">üìä Informa√ß√µes B√°sicas</h3>
                <form id="basicInfoForm">
                    <div class="form-group">
                        <label for="projectName">Nome do Projeto</label>
                        <input type="text" id="projectName" name="projectName" required>
                    </div>
                    <div class="form-group">
                        <label for="network">Rede</label>
                        <select id="network" name="network">
                            <option value="Ethereum">Ethereum</option>
                            <option value="Solana">Solana</option>
                            <option value="Polygon">Polygon</option>
                            <option value="Arbitrum">Arbitrum</option>
                            <option value="Base">Base</option>
                            <option value="BNB Chain">BNB Chain</option>
                            <option value="Avalanche">Avalanche</option>
                            <option value="Other">Outra</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="numberOfWLs">N√∫mero de WLs</label>
                        <input type="number" id="numberOfWLs" name="numberOfWLs" min="0" required>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" id="saveBasicBtn">
                            üíæ Salvar Altera√ß√µes
                        </button>
                    </div>
                </form>
            </div>

            <div class="info-card">
                <h3 class="card-title">üìù Descri√ß√£o dos Templates</h3>
                <form id="templateForm">
                    <div class="form-group">
                        <label for="templateDescription">Descri√ß√£o</label>
                        <textarea id="templateDescription" name="templateDescription" 
                                  placeholder="Descreva os templates enviados pelo projeto..."></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" id="saveTemplateBtn">
                            üíæ Salvar Descri√ß√£o
                        </button>
                    </div>
                </form>
            </div>

            <div class="info-card">
                <h3 class="card-title">üí∞ Wallets Coletadas</h3>
                <form id="walletsForm">
                    <div class="form-group">
                        <label for="collectedWallets">Wallets (uma por linha)</label>
                        <textarea id="collectedWallets" name="collectedWallets" 
                                  placeholder="Cole as wallets aqui, uma por linha..."
                                  style="min-height: 200px; font-family: 'Courier New', monospace;"></textarea>
                    </div>
                    <div class="form-group">
                        <small>Total de wallets: <span id="walletCount">0</span></small>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" id="saveWalletsBtn">
                            üíæ Salvar Wallets
                        </button>
                    </div>
                </form>
            </div>

            <div class="info-card">
                <h3 class="card-title">‚öôÔ∏è A√ß√µes</h3>
                <div class="btn-group" style="flex-direction: column;">
                    <button class="btn btn-danger" id="deleteBtn" onclick="deletePartnership()">
                        üóëÔ∏è Apagar Parceria
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class PartnershipDetails {
            constructor() {
                this.partnershipId = null;
                this.partnership = null;
                this.currentUser = null;
                this.token = null;
                this.canEdit = false;
                this.canDelete = false;
                
                this.init();
            }

            async init() {
                // Pega o ID da parceria da URL
                const urlParams = new URLSearchParams(window.location.search);
                this.partnershipId = urlParams.get('id');
                
                if (!this.partnershipId) {
                    this.showNotification('ID da parceria n√£o encontrado', 'error');
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);
                    return;
                }

                // Verifica autentica√ß√£o
                const authenticated = await this.checkAuthentication();
                if (!authenticated) {
                    window.location.href = '/';
                    return;
                }

                await this.loadPartnership();
                this.setupForms();
                this.updateWalletCount();
            }

            async checkAuthentication() {
                this.token = localStorage.getItem('auth_token');
                if (!this.token) {
                    return false;
                }

                try {
                    const response = await fetch('/api/auth/verify', {
                        headers: {
                            'Authorization': `Bearer ${this.token}`
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.currentUser = result.user;
                        document.getElementById('userInfo').textContent = `üë§ ${this.currentUser.name}`;
                        return true;
                    } else {
                        localStorage.removeItem('auth_token');
                        return false;
                    }
                } catch (error) {
                    console.error('Erro na verifica√ß√£o:', error);
                    return false;
                }
            }

            async loadPartnership() {
                this.showLoading(true);
                
                try {
                    const response = await fetch('/api/partnerships', {
                        headers: {
                            'Authorization': `Bearer ${this.token}`
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.partnership = result.data.find(p => p.id === this.partnershipId);
                        
                        if (!this.partnership) {
                            throw new Error('Parceria n√£o encontrada');
                        }

                        // Verifica permiss√µes
                        this.canEdit = this.currentUser.role === 'admin' || 
                                      this.partnership.createdByEmail === this.currentUser.email;
                        this.canDelete = this.canEdit;

                        this.renderPartnership();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Erro ao carregar parceria:', error);
                    this.showNotification('Erro ao carregar parceria', 'error');
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);
                } finally {
                    this.showLoading(false);
                }
            }

            renderPartnership() {
                // Header
                document.getElementById('partnershipTitle').textContent = 
                    this.partnership.projectName || 'Sem nome';
                document.getElementById('networkBadge').textContent = 
                    this.partnership.network || 'Ethereum';
                document.getElementById('createdBy').textContent = 
                    this.partnership.createdBy || 'Desconhecido';
                document.getElementById('createdDate').textContent = 
                    new Date(this.partnership.createdAt).toLocaleDateString('pt-BR');
                document.getElementById('lastModified').textContent = 
                    this.partnership.lastModifiedBy ? 
                    `${this.partnership.lastModifiedBy} em ${new Date(this.partnership.updatedAt).toLocaleDateString('pt-BR')}` : 
                    'Nunca modificado';

                // Formul√°rios
                document.getElementById('projectName').value = this.partnership.projectName || '';
                document.getElementById('network').value = this.partnership.network || 'Ethereum';
                document.getElementById('numberOfWLs').value = this.partnership.numberOfWLs || 0;
                document.getElementById('templateDescription').value = this.partnership.templateDescription || '';
                document.getElementById('collectedWallets').value = this.partnership.collectedWallets || '';

                // Desabilita campos se n√£o pode editar
                if (!this.canEdit) {
                    document.querySelectorAll('input, textarea, select').forEach(el => {
                        el.disabled = true;
                    });
                    document.querySelectorAll('.btn-primary').forEach(btn => {
                        btn.disabled = true;
                        btn.textContent = 'üîí Sem permiss√£o';
                    });
                }

                // Bot√£o de deletar
                const deleteBtn = document.getElementById('deleteBtn');
                if (!this.canDelete) {
                    deleteBtn.disabled = true;
                    deleteBtn.textContent = 'üîí Sem permiss√£o para apagar';
                }

                this.updateWalletCount();
            }

            setupForms() {
                // Form de informa√ß√µes b√°sicas
                document.getElementById('basicInfoForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!this.canEdit) return;

                    const formData = new FormData(e.target);
                    await this.updatePartnership({
                        projectName: formData.get('projectName'),
                        network: formData.get('network'),
                        numberOfWLs: parseInt(formData.get('numberOfWLs')) || 0
                    });
                });

                // Form de template
                document.getElementById('templateForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!this.canEdit) return;

                    const formData = new FormData(e.target);
                    await this.updatePartnership({
                        templateDescription: formData.get('templateDescription')
                    });
                });

                // Form de wallets
                document.getElementById('walletsForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!this.canEdit) return;

                    const formData = new FormData(e.target);
                    await this.updatePartnership({
                        collectedWallets: formData.get('collectedWallets')
                    });
                });

                // Contador de wallets
                document.getElementById('collectedWallets').addEventListener('input', () => {
                    this.updateWalletCount();
                });
            }

            updateWalletCount() {
                const wallets = document.getElementById('collectedWallets').value;
                const lines = wallets.split('\n').filter(line => line.trim());
                document.getElementById('walletCount').textContent = lines.length;
            }

            async updatePartnership(data) {
                this.showLoading(true);

                try {
                    const response = await fetch(`/api/partnerships/${this.partnershipId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.token}`
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.partnership = result.data;
                        this.renderPartnership();
                        this.showNotification('Altera√ß√µes salvas com sucesso!', 'success');
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Erro ao atualizar:', error);
                    this.showNotification(error.message || 'Erro ao salvar altera√ß√µes', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async deletePartnership() {
                if (!this.canDelete) {
                    this.showNotification('Voc√™ n√£o tem permiss√£o para apagar esta parceria', 'error');
                    return;
                }

                if (!confirm('Tem certeza que deseja apagar esta parceria? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                this.showLoading(true);

                try {
                    const response = await fetch(`/api/partnerships/${this.partnershipId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${this.token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showNotification('Parceria removida com sucesso!', 'success');
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 1500);
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    this.showNotification(error.message || 'Erro ao remover parceria', 'error');
                    this.showLoading(false);
                }
            }

            showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                overlay.style.display = show ? 'flex' : 'none';
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 5px;">
                        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}
                        ${type === 'success' ? 'Sucesso' : type === 'error' ? 'Erro' : 'Info'}
                    </div>
                    <div>${message}</div>
                `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 4000);
            }
        }

        // Inicializa
        const details = new PartnershipDetails();

        // Fun√ß√£o global para deletar
        function deletePartnership() {
            details.deletePartnership();
        }
    </script>
</body>
</html>